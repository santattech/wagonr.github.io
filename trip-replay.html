<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Replay - GPS Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="stylesheets/tracker.css?v=1.1">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@9.0.0/dist/pouchdb.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Trip Replay</h1>
            <a href="trips.html" class="back-btn">‚Üê Back to Trips</a>
        </header>
        
        <div class="replay-controls">
            <button id="play-btn" class="control-btn">‚ñ∂Ô∏è Play</button>
            <button id="pause-btn" class="control-btn" disabled>‚è∏Ô∏è Pause</button>
            <button id="reset-btn" class="control-btn">üîÑ Reset</button>
            <div class="speed-control">
                <label>Speed: 
                    <select id="replay-speed">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                    </select>
                </label>
            </div>
        </div>
        
        <div class="trip-info">
            <h3 id="trip-title">Loading trip...</h3>
            <div class="replay-stats">
                <div class="stat-item">
                    <span class="stat-label">Current Speed:</span>
                    <span id="current-replay-speed" class="stat-value">0 km/h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Distance:</span>
                    <span id="current-distance" class="stat-value">0.0 km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Top Speed:</span>
                    <span id="top-speed" class="stat-value">0 km/h</span>
                </div>
            </div>
            <div class="progress-info">
                <span id="current-time">00:00</span> / <span id="total-time">00:00</span>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="replay-progress">0%</div>
                </div>
            </div>
        </div>
        
        <div class="speed-analysis-card">
            <h3>üöó Speed Analysis</h3>
            <div class="speed-breakdown">
                <div class="speed-range">
                    <span class="range-label">0-10 km/h:</span>
                    <span class="range-value" id="value-0-10">0 km</span>
                </div>
                <div class="speed-range">
                    <span class="range-label">10-30 km/h:</span>
                    <span class="range-value" id="value-10-30">0 km</span>
                </div>
                <div class="speed-range">
                    <span class="range-label">30-60 km/h:</span>
                    <span class="range-value" id="value-30-60">0 km</span>
                </div>
                <div class="speed-range">
                    <span class="range-label">60-80 km/h:</span>
                    <span class="range-value" id="value-60-80">0 km</span>
                </div>
                <div class="speed-range">
                    <span class="range-label">80+ km/h:</span>
                    <span class="range-value" id="value-80-plus">0 km</span>
                </div>
            </div>
        </div>
        
        <div id="replay-map" class="map-container"></div>
    </div>

    <script>
        const dbTrips = new PouchDB("tripsDB");
        let currentTrip = null;
        let replayMap = null;
        let pathPolyline = null;
        let currentMarker = null;
        let replayInterval = null;
        let currentIndex = 0;
        let replaySpeed = 1;
        
        // Get trip ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('id');
        
        // Initialize map
        replayMap = L.map('replay-map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(replayMap);
        
        // Load trip data
        async function loadTrip() {
            try {
                currentTrip = await dbTrips.get(tripId);
                
                // If speed analysis doesn't exist, calculate it
                if (!currentTrip.speedAnalysis) {
                    currentTrip.speedAnalysis = calculateSpeedAnalysisForTrip(currentTrip);
                    // Save updated trip with speed analysis
                    await dbTrips.put(currentTrip);
                }
                
                displayTripInfo();
                displaySpeedAnalysis();
                setupMap();
            } catch (error) {
                document.getElementById('trip-title').textContent = 'Trip not found';
            }
        }
        
        function displaySpeedAnalysis() {
            if (!currentTrip.speedAnalysis) return;
            
            const speedRanges = currentTrip.speedAnalysis.speedRanges;
            
            // Display top speed
            document.getElementById('top-speed').textContent = currentTrip.speedAnalysis.topSpeed + ' km/h';
            
            // Display speed breakdown
            document.getElementById('value-0-10').textContent = speedRanges['0-10'].toFixed(2) + ' km';
            document.getElementById('value-10-30').textContent = speedRanges['10-30'].toFixed(2) + ' km';
            document.getElementById('value-30-60').textContent = speedRanges['30-60'].toFixed(2) + ' km';
            document.getElementById('value-60-80').textContent = speedRanges['60-80'].toFixed(2) + ' km';
            document.getElementById('value-80-plus').textContent = speedRanges['80+'].toFixed(2) + ' km';
        }
        
        function calculateSpeedAnalysisForTrip(trip) {
            if (!trip.path || trip.path.length < 2) {
                return {
                    speedRanges: {
                        '0-10': 0,
                        '10-30': 0,
                        '30-60': 0,
                        '60-80': 0,
                        '80+': 0
                    },
                    topSpeed: 0
                };
            }
            
            const speedRanges = {
                '0-10': 0,
                '10-30': 0,
                '30-60': 0,
                '60-80': 0,
                '80+': 0
            };
            
            let topSpeed = 0;
            
            // Calculate speed between each point
            for (let i = 1; i < trip.path.length; i++) {
                const prevPoint = trip.path[i - 1];
                const currentPoint = trip.path[i];
                
                const distance = calculateDistance(prevPoint.lat, prevPoint.lon, currentPoint.lat, currentPoint.lon);
                const speed = distance * 3600; // Convert to km/h
                
                if (speed > topSpeed) {
                    topSpeed = speed;
                }
                
                // Categorize speed
                if (speed <= 10) {
                    speedRanges['0-10'] += distance;
                } else if (speed <= 30) {
                    speedRanges['10-30'] += distance;
                } else if (speed <= 60) {
                    speedRanges['30-60'] += distance;
                } else if (speed <= 80) {
                    speedRanges['60-80'] += distance;
                } else {
                    speedRanges['80+'] += distance;
                }
            }
            
            return {
                speedRanges,
                topSpeed: Math.round(topSpeed * 10) / 10
            };
        }
        
        function displayTripInfo() {
            const startTime = new Date(currentTrip.startTime);
            document.getElementById('trip-title').textContent = 
                `Trip ${startTime.toLocaleDateString()} ${startTime.toLocaleTimeString()}`;
            
            const duration = Math.floor(currentTrip.duration);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('total-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function setupMap() {
            if (!currentTrip.path || currentTrip.path.length === 0) return;
            
            // Draw complete path
            const pathCoords = currentTrip.path.map(p => [p.lat, p.lon]);
            pathPolyline = L.polyline(pathCoords, {color: 'blue', weight: 3, opacity: 0.5}).addTo(replayMap);
            
            // Fit map to path
            replayMap.fitBounds(pathPolyline.getBounds());
            
            // Add start marker
            L.marker([currentTrip.path[0].lat, currentTrip.path[0].lon])
                .bindPopup('Start')
                .addTo(replayMap);
            
            // Add end marker
            const lastPoint = currentTrip.path[currentTrip.path.length - 1];
            L.marker([lastPoint.lat, lastPoint.lon])
                .bindPopup('End')
                .addTo(replayMap);
            
            // Add current position marker
            currentMarker = L.marker([currentTrip.path[0].lat, currentTrip.path[0].lon], {
                icon: L.icon({
                    iconUrl: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI3IiBjeT0iMTciIHI9IjQiIGZpbGw9IiM0Q0FGNTAiLz48Y2lyY2xlIGN4PSIxNyIgY3k9IjE3IiByPSI0IiBmaWxsPSIjNENCQUY1MCIvPjxwYXRoIGQ9Ik03IDE3IDEwIDEwIDEzIDE3IiBzdHJva2U9IiMyRTdEMzIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTEwIDEwIDE0IDEwIDE3IDE3IiBzdHJva2U9IiMyRTdEMzIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMS41IiBmaWxsPSIjMkU3RDMyIi8+PC9zdmc+",
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(replayMap);
        }
        
        function startReplay() {
            if (!currentTrip.path || replayInterval) return;
            
            document.getElementById('play-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            
            const intervalMs = 1000 / replaySpeed;
            replayInterval = setInterval(updateReplay, intervalMs);
        }
        
        function pauseReplay() {
            if (replayInterval) {
                clearInterval(replayInterval);
                replayInterval = null;
            }
            
            document.getElementById('play-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }
        
        function resetReplay() {
            pauseReplay();
            currentIndex = 0;
            updateReplay();
        }
        
        function updateReplay() {
            if (!currentTrip.path || currentIndex >= currentTrip.path.length) {
                pauseReplay();
                return;
            }
            
            const point = currentTrip.path[currentIndex];
            currentMarker.setLatLng([point.lat, point.lon]);
            
            // Calculate speed between points
            let speed = 0;
            if (currentIndex > 0) {
                const prevPoint = currentTrip.path[currentIndex - 1];
                const distance = calculateDistance(prevPoint.lat, prevPoint.lon, point.lat, point.lon);
                const timeInterval = 1; // Assuming 1 second between points
                speed = (distance / timeInterval) * 3600; // Convert to km/h
            }
            
            // Update speed display
            document.getElementById('current-replay-speed').textContent = speed.toFixed(1) + ' km/h';
            
            // Update distance
            const totalDistance = (currentIndex / currentTrip.path.length) * currentTrip.totalDistance;
            document.getElementById('current-distance').textContent = totalDistance.toFixed(2) + ' km';
            
            // Update progress
            const progress = (currentIndex / (currentTrip.path.length - 1)) * 100;
            document.getElementById('replay-progress').style.width = progress + '%';
            document.getElementById('replay-progress').textContent = Math.floor(progress) + '%';
            
            // Update time
            const elapsed = Math.floor((currentIndex / currentTrip.path.length) * currentTrip.duration);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('current-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            currentIndex++;
        }
        
        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Event listeners
        document.getElementById('play-btn').addEventListener('click', startReplay);
        document.getElementById('pause-btn').addEventListener('click', pauseReplay);
        document.getElementById('reset-btn').addEventListener('click', resetReplay);
        
        document.getElementById('replay-speed').addEventListener('change', function(e) {
            replaySpeed = parseFloat(e.target.value);
            if (replayInterval) {
                pauseReplay();
                startReplay();
            }
        });
        
        // Load trip on page load
        if (tripId) {
            loadTrip();
        } else {
            document.getElementById('trip-title').textContent = 'No trip selected';
        }
    </script>
</body>
</html>
